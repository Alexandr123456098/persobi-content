import os
import asyncio
import logging
from typing import Dict, Optional

from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, FSInputFile
from aiogram.filters import CommandStart

import httpx

# --- env ----------------------------------------------------------------------
from dotenv import load_dotenv
load_dotenv("/opt/content_factory/.env")

BOT_TOKEN = os.getenv("BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4o-mini")
OUT_DIR = os.getenv("OUT_DIR", "/opt/content_factory/out")

os.makedirs(OUT_DIR, exist_ok=True)

logging.basicConfig(level=logging.INFO, format="%(asctime)s %(levelname)s %(message)s")
LOG = logging.getLogger("bot")
LOG.info(
    "ENV CHECK: BOT_TOKEN=%s, OPENAI=%s, MODEL=%s, OUT_DIR=%s",
    (BOT_TOKEN[:8] + "..." if BOT_TOKEN else "EMPTY"),
    "SET" if OPENAI_API_KEY else "EMPTY",
    OPENAI_MODEL,
    OUT_DIR,
)

# --- state --------------------------------------------------------------------
# –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–≥–µ–Ω–µ—Ä—ë–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ —á–∞—Ç—É
LAST_PROMPT: Dict[int, str] = {}

# --- helpers ------------------------------------------------------------------
async def call_openai(system: str, user: str) -> str:
    """–ë–µ—Ä—ë–º —Ä–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç —É OpenAI (chat.completions)."""
    if not OPENAI_API_KEY:
        return "üîß OPENAI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É—é —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å."
    headers = {
        "Authorization": f"Bearer {OPENAI_API_KEY}",
        "Content-Type": "application/json",
    }
    body = {
        "model": OPENAI_MODEL,
        "messages": [
            {"role": "system", "content": system},
            {"role": "user", "content": user},
        ],
        "temperature": 0.7,
        "max_tokens": 700,
    }
    async with httpx.AsyncClient(timeout=60) as cli:
        r = await cli.post("https://api.openai.com/v1/chat/completions", headers=headers, json=body)
        r.raise_for_status()
        data = r.json()
        return data["choices"][0]["message"]["content"].strip()

# –ø—Ä–æ—Å—Ç–æ–π –∑–∞–≥–ª—É—à–µ—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–µ—Ä (—É –Ω–∞—Å –æ–Ω –ª–µ–∂–∏—Ç –≤ adapters/ffmpeg_stub.py)
from adapters import render_videos

# --- bot wiring ---------------------------------------------------------------
dp = Dispatcher()

@dp.message(CommandStart())
async def on_start(m: Message):
    await m.answer(
        "–Ø —Å–æ–±–µ—Ä—É —Ä–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –∏ —Å–¥–µ–ª–∞—é —á–µ—Ä–Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ.\n"
        "–ù–∞–ø–∏—à–∏ –∏–¥–µ—é (–º–æ–∂–Ω–æ —Å —Ñ–æ—Ç–æ)."
    )

@dp.message(F.text & ~F.text.in_({"1", "2", "3"}))
async def on_text(m: Message):
    chat_id = m.chat.id
    text = m.text or ""
    LOG.info("Incoming text chat_id=%s text=%r", chat_id, text)

    system = (
        "–¢—ã —Ä–µ–∂–∏—Å—Å—ë—Ä. –í–æ–∑–≤—Ä–∞—â–∞–π –æ–¥–∏–Ω —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–¥–µ–æ "
        "—Å –±–ª–æ–∫–∞–º–∏: Scene / Setting / Subjects / Action / Camera / Lighting / Mood / Details. "
        "–ù–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π."
    )
    prompt = await call_openai(system, text) if text else "A nice short scene."

    LAST_PROMPT[chat_id] = prompt

    await m.answer(
        "–í–æ—Ç —Ç–≤–æ–π —Ä–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç (–∫–æ–ø–∏—Ä—É–π –∫—É–¥–∞ —Ö–æ—á–µ—à—å):\n\n"
        f"{prompt}\n\n–°–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ —Å–¥–µ–ª–∞—Ç—å: 1, 2 –∏–ª–∏ 3?"
    )

@dp.message(F.text.in_({"1", "2", "3"}))
async def on_choose_count(m: Message):
    chat_id = m.chat.id
    n = int(m.text.strip())
    prompt = LAST_PROMPT.get(chat_id)
    if not prompt:
        await m.answer("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—à–ª–∏ –∏–¥–µ—é, —è —Å–æ–±–µ—Ä—É –ø—Ä–æ–º–ø—Ç üòâ")
        return

    LOG.info("Render start chat_id=%s n=%s", chat_id, n)
    await m.answer(f"–û–∫–µ–π, —Ä–µ–Ω–¥–µ—Ä—é {n} –≤–∏–¥–µ–æ‚Ä¶ (—á–µ—Ä–Ω–æ–≤–∏–∫–∏)")

    try:
        files = await render_videos(prompt, n, OUT_DIR)
        LOG.info("Render done files=%r", files)
        for path in files:
            # –í–ê–ñ–ù–û: –≤ aiogram v3 –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å FSInputFile
            video = FSInputFile(path)
            with open(video, "rb") as _f:
            await m.answer_video(_f, caption=f"–ß–µ—Ä–Ω–æ–≤–∏–∫ ¬∑ –ø—Ä–æ–≤–∞–π–¥–µ—Ä: {os.getenv('_LAST_PROVIDER','FFMPEG')}")
    except Exception as e:
        LOG.exception("send_video error")
        await m.answer(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ: {e}")

async def main():
    if not BOT_TOKEN:
        raise SystemExit("BOT_TOKEN –ø—É—Å—Ç ‚Äî –∑–∞–¥–∞–π—Ç–µ –≤ .env")
    bot = Bot(BOT_TOKEN)
    LOG.info("Start polling")
    await dp.start_polling(bot)

if __name__ == "__main__":
    import uvloop
    uvloop.install()
    asyncio.run(main())
