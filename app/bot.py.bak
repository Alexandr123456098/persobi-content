import os, shlex, asyncio, time
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from dotenv import load_dotenv

# === ENV ===
load_dotenv(dotenv_path=os.path.join("/opt/content_factory", ".env"))
BOT_TOKEN = os.getenv("BOT_TOKEN", "")
OUT_DIR = os.getenv("OUT_DIR", "/opt/content_factory/out")
PROVIDERS = [p.strip() for p in os.getenv("PROVIDERS", "replicate,offline").split(",") if p.strip()]
USE_LUMA_4K = os.getenv("USE_LUMA_4K", "0") in ("1", "true", "yes")

if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω")

os.makedirs(OUT_DIR, exist_ok=True)

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

# –ö–ª–∏–µ–Ω—Ç—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (–ª–µ–Ω–∏–≤—ã–π –∏–º–ø–æ—Ä—Ç)
_clients = {}
def _get_client(name: str):
    name = name.lower()
    if name in _clients:
        return _clients[name]
    if name == "replicate":
        from app.adapters.replicate_adapter import ReplicateClient
        _clients[name] = ReplicateClient(OUT_DIR)
        return _clients[name]
    if name in ("offline", "ffmpeg"):
        from app.adapters.offline_adapter import OfflineClient
        _clients[name] = OfflineClient(OUT_DIR)
        return _clients[name]
    raise RuntimeError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä: {name}")

# –ü–æ—Å—Ç–ø—Ä–æ—Ü (–ª–æ–∫–∞–ª—å–Ω—ã–π TTS/–∞–ø—Å–∫–µ–π–ª)
from app.utils.media import upscale_4k  # TTS –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ –ø–æ –∂–µ–ª–∞–Ω–∏—é

HELP_TEXT = (
    "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Persobi Content Combine!\n\n"
    "–ù–∞–ø–∏—à–∏ –∏–¥–µ—é ‚Äî —è —Å–æ–±–µ—Ä—É —Ä–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –∏ —Å–¥–µ–ª–∞—é –≤–∏–¥–µ–æ.\n"
    "–ü—Ä–∏–º–µ—Ä—ã:\n"
    "‚Ä¢ —Å–¥–µ–ª–∞–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –≤–∏–¥–µ–æ, –≥–¥–µ –±–∞–±—É—à–∫–∞ –≤—è–∂–µ—Ç –Ω–æ—Å–∫–∏\n"
    "‚Ä¢ —Ä–µ–∫–ª–∞–º–∞ –∫—Ä–æ—Å—Å–æ–≤–æ–∫ –Ω–∞–π–∫, –¥–∏–Ω–∞–º–∏—á–Ω–∞—è, 5 —Å–µ–∫—É–Ω–¥\n\n"
    "–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–µ—Ö–Ω–∞—Ä–µ–π (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): /video <—Ç–µ–∫—Å—Ç> [--4k]\n"
    f"–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã —Å–µ–π—á–∞—Å: {', '.join(PROVIDERS)}\n"
)

def build_director_prompt(user_text: str) -> str:
    """
    –ü—Ä–æ—Å—Ç–æ–π ¬´—Ä–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç¬ª: –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ–º –∏–¥–µ—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –≠—Ç–æ MVP-–≤–µ—Ä—Å–∏—è: –±–µ–∑ –º–∞–≥–∏–∏, –Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ.
    """
    t = (user_text or "").strip()
    return (
        f"{t}\n"
        "Style: cinematic, natural lighting, realistic motion, steady camera.\n"
        "Framing: varied shots, close-ups and medium shots, tasteful composition.\n"
        "Motion: smooth 24‚Äì30fps, slight camera movement, minimal jitter.\n"
        "Quality: coherent, detailed, pleasing color grading.\n"
        "Duration: ~5s.\n"
    )

async def _show_spinner(message: types.Message, prefix: str, stop_event: asyncio.Event):
    dots = ["", ".", "..", "..."]
    i = 0
    status_msg = await message.reply(f"{prefix} ‚Ä¶")
    try:
        while not stop_event.is_set():
            await asyncio.sleep(1.2)
            await status_msg.edit_text(f"{prefix} {dots[i%4]}")
            i += 1
    finally:
        # —Ç–∏—Ö–æ –∑–∞–≤–µ—Ä—à–∏–º; –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Ç–µ–∫—Å—Ç (–µ–≥–æ –ø–µ—Ä–µ–ø–∏—à–µ—Ç –≤—ã–∑—ã–≤–∞—é—â–∞—è –ª–æ–≥–∏–∫–∞)
        pass
    return status_msg

async def _generate_with_fallback(prompt: str, progress_msg: types.Message):
    last_err = None
    for provider in PROVIDERS:
        try:
            await progress_msg.edit_text(f"üõ† {provider}: –≥–µ–Ω–µ—Ä–∏—Ä—É—é‚Ä¶")
            client = _get_client(provider)
            loop = asyncio.get_event_loop()
            path = await loop.run_in_executor(None, client.generate, prompt)
            await progress_msg.edit_text(f"‚úÖ {provider}: –≥–æ—Ç–æ–≤–æ")
            return provider, path
        except Exception as e:
            last_err = e
            await progress_msg.edit_text(f"‚ö†Ô∏è {provider}: {e}")
            await asyncio.sleep(0.8)
    raise last_err if last_err else RuntimeError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª–∏–∫")

# –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ 4K –∑–Ω–∞–ª–∞, —á—Ç–æ –∞–ø—Å–∫–µ–π–ª–∏—Ç—å
_last_video_by_user = {}  # user_id -> {"path": str, "prompt": str}

def _make_actions_keyboard():
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("üîÅ 4K", callback_data="do_4k"))
    return kb

@dp.message_handler(commands=["start"])
async def start_cmd(m: types.Message):
    await m.reply(HELP_TEXT)

@dp.message_handler(commands=["health"])
async def health_cmd(m: types.Message):
    rep_token = "set" if os.getenv("REPLICATE_API_TOKEN") else "unset"
    model = os.getenv("REPLICATE_MODEL", "tencent/hunyuan-video")
    version = os.getenv("REPLICATE_MODEL_VERSION", "")[:12] + "..." if os.getenv("REPLICATE_MODEL_VERSION") else "(auto)"
    txt = (
        "Health:\n"
        f"- OUT_DIR: {OUT_DIR}\n"
        f"- PROVIDERS: {', '.join(PROVIDERS)}\n"
        f"- Replicate token: {rep_token}\n"
        f"- Replicate model (slug): {model}\n"
        f"- Replicate version: {version}\n"
        f"- 4K —á–µ—Ä–µ–∑ Luma: {'ON' if USE_LUMA_4K else 'OFF (–ª–æ–∫–∞–ª—å–Ω—ã–π –∞–ø—Å–∫–µ–π–ª)'}\n"
    )
    await m.reply(txt)

def _parse_video_args(text: str):
    parts = shlex.split(text or "")
    if parts and parts[0].startswith("/video"):
        parts = parts[1:]
    flags = set(p for p in parts if p.startswith("--"))
    prompt_text = " ".join(p for p in parts if not p.startswith("--")).strip()
    want_4k = "--4k" in flags
    return prompt_text, want_4k

async def _handle_generation(m: types.Message, user_text: str, force_4k: bool = False):
    # 1) ¬´—Ä–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç¬ª
    director_prompt = build_director_prompt(user_text)
    await m.reply(f"üé¨ –†–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç:\n```\n{director_prompt}\n```", parse_mode="Markdown")

    # 2) —Å–ø–∏–Ω–Ω–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    stop_event = asyncio.Event()
    spinner_task = asyncio.create_task(_show_spinner(m, "üé• –î–µ–ª–∞—é –≤–∏–¥–µ–æ", stop_event))

    try:
        # 3) –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ
        provider, video_path = await _generate_with_fallback(director_prompt, m)
    finally:
        stop_event.set()
        await asyncio.sleep(0.1)

    # 4) –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ + –∫–Ω–æ–ø–∫–∏
    await m.reply_video(open(video_path, "rb"), caption=f"{provider} ‚úÖ", reply_markup=_make_actions_keyboard())
    _last_video_by_user[m.from_user.id] = {"path": video_path, "prompt": director_prompt}

    # 5) –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É 4K (–µ—Å–ª–∏ –ø—Ä–æ—Å–∏–ª–∏ —Ñ–ª–∞–≥–æ–º)
    if force_4k:
        await _do_4k_flow(m)

@dp.message_handler(commands=["video"])
async def video_cmd(m: types.Message):
    text, want_4k = _parse_video_args(m.text or "")
    if not text:
        await m.reply("–ù—É–∂–Ω–æ —Ç–∞–∫: /video <—Ç–µ–∫—Å—Ç> [--4k]\n–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –∏–¥–µ—é —Å–æ–æ–±—â–µ–Ω–∏–µ–º.")
        return
    await _handle_generation(m, text, force_4k=want_4k)

@dp.message_handler(content_types=["text"])
async def free_text_cmd(m: types.Message):
    # –°–≤–æ–±–æ–¥–Ω–∞—è —Ñ–æ—Ä–º–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ—Ç –∏–¥–µ—é
    text = (m.text or "").strip()
    if not text:
        return
    await _handle_generation(m, text, force_4k=False)

async def _do_4k_flow(m: types.Message):
    info = _last_video_by_user.get(m.from_user.id)
    if not info:
        await m.reply("–ù–µ –≤–∏–∂—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–¥–µ–æ. –û—Ç–ø—Ä–∞–≤—å –Ω–æ–≤—É—é –∏–¥–µ—é —Ç–µ–∫—Å—Ç–æ–º, –∏ —è —Å–¥–µ–ª–∞—é 4K –ø–æ—Å–ª–µ.")
        return

    src_path = info["path"]
    # –ü–ª–∞—à–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    msg = await m.reply("üß© –î–µ–ª–∞—é 4K –∞–ø—Å–∫–µ–π–ª‚Ä¶")
    try:
        if USE_LUMA_4K:
            # TODO: —Å—é–¥–∞ –ø–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º Luma-–∫–ª–∏–µ–Ω—Ç (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–Ω–æ–ø–∫–∏ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ç–µ–º –∂–µ)
            raise RuntimeError("Luma –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –≤ —ç—Ç–æ–º MVP. –ò—Å–ø–æ–ª—å–∑—É–π –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–ø—Å–∫–µ–π–ª (USE_LUMA_4K=0).")
        else:
            loop = asyncio.get_event_loop()
            up4k = await loop.run_in_executor(None, upscale_4k, src_path, OUT_DIR)
            await msg.edit_text("‚úÖ 4K –∞–ø—Å–∫–µ–π–ª –≥–æ—Ç–æ–≤")
            await m.reply_video(open(up4k, "rb"), caption="–õ–æ–∫–∞–ª—å–Ω—ã–π 4K ‚úÖ")
            _last_video_by_user[m.from_user.id]["path"] = up4k
    except Exception as e:
        await msg.edit_text(f"‚ö†Ô∏è 4K –Ω–µ —É–¥–∞–ª—Å—è: {e}")

@dp.callback_query_handler(lambda c: c.data == "do_4k")
async def cb_do_4k(c: types.CallbackQuery):
    await c.answer("–ó–∞–ø—É—Å–∫–∞—é 4K‚Ä¶")
    await _do_4k_flow(c.message)

def main():
    executor.start_polling(dp, skip_updates=True)

if __name__ == "__main__":
    main()
