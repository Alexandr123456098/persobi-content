from aiogram import types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
import os, asyncio

# –ë–µ—Ä—ë–º –æ–±–∞ –∫–ª–∏–µ–Ω—Ç–∞: Replicate ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π, Offline ‚Äî –Ω–∞ –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫—É
from app.adapters import ReplicateClient
from app.adapters.offline_adapter import OfflineClient

OUT_DIR = os.environ.get("OUT_DIR","/opt/content_factory/out")
replicate = ReplicateClient(OUT_DIR)
offline = OfflineClient(OUT_DIR)

def kb_ready():
    kb = InlineKeyboardMarkup(row_width=3)
    kb.row(
        InlineKeyboardButton("üîÅ –ï—â—ë —Ä–∞–∑", callback_data="again"),
        InlineKeyboardButton("üìê 720p/1080p", callback_data="toggle_res"),
        InlineKeyboardButton("üü© 4K", callback_data="make_4k"),
    )
    return kb

async def _gen_replicate(prompt: str, seconds: int = 5):
    # ReplicateClient.generate ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π; —É–≤–æ–¥–∏–º –≤ executor, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(None, replicate.generate, prompt, seconds)

async def handle_text(message: types.Message, state):
    prompt = (message.text or "").strip()
    if not prompt:
        return
    wait = await message.answer("üõ† –ì–µ–Ω–µ—Ä–∏—Ä—É—é‚Ä¶")
    try:
        # –ü—ã—Ç–∞–µ–º—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ç—å –≤ Replicate
        path = await _gen_replicate(prompt, 5)
        await message.answer_video(open(path,"rb"),
                                   caption="‚úÖ –ì–æ—Ç–æ–≤–æ. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: 720p, 5 —Å–µ–∫.",
                                   reply_markup=kb_ready())
    except Exception as e:
        # –§–æ–ª–±—ç–∫ –Ω–∞ –æ—Ñ–ª–∞–π–Ω, –µ—Å–ª–∏ —Ä–µ–ø–ª–∏–∫–µ–π—Ç –ª—è–∂–µ—Ç
        try:
            p2 = await offline.generate_video(prompt, seconds=5)
            await message.answer_video(open(p2,"rb"),
                                       caption="‚úÖ –ì–æ—Ç–æ–≤–æ. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: 720p, 5 —Å–µ–∫. (offline)",
                                       reply_markup=kb_ready())
        except Exception as e2:
            await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}\n–¢–∞–∫–∂–µ –Ω–µ –≤—ã—à–ª–æ –æ—Ñ–ª–∞–π–Ω: {e2}")
    finally:
        try:
            await wait.delete()
        except Exception:
            pass

async def handle_callback(query: types.CallbackQuery, state):
    data = query.data
    msg = query.message

    # –î–æ—Å—Ç–∞—ë–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –±—ã–ª)
    seed = (msg.caption or msg.text or "").strip() or "–ö–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω–∞—è —Å—Ü–µ–Ω–∞"

    if data == "again":
        w = await msg.answer("üîÅ –ï—â—ë —Ä–∞–∑‚Ä¶")
        try:
            path = await _gen_replicate(seed, 5)
            await msg.answer_video(open(path,"rb"),
                                   caption="‚úÖ –ì–æ—Ç–æ–≤–æ. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: 720p, 5 —Å–µ–∫.",
                                   reply_markup=kb_ready())
        except Exception as e:
            try:
                p2 = await offline.generate_video(seed, seconds=5)
                await msg.answer_video(open(p2,"rb"),
                                       caption="‚úÖ –ì–æ—Ç–æ–≤–æ. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: 720p, 5 —Å–µ–∫. (offline)",
                                       reply_markup=kb_ready())
            except Exception as e2:
                await msg.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}\n–¢–∞–∫–∂–µ –Ω–µ –≤—ã—à–ª–æ –æ—Ñ–ª–∞–π–Ω: {e2}")
        finally:
            try: await w.delete()
            except Exception: pass
        return await query.answer()

    if data == "toggle_res":
        # –ó–∞–≥–ª—É—à–∫–∞ UI ‚Äî —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ—Å–∞–π–∑–∞ (–ø–æ–¥—Ü–µ–ø–∏–º –ø–æ–∑–∂–µ)
        await msg.answer("üìê –ü–µ—Ä–µ–∫–ª—é—á–∏–ª 720p‚Üî1080p (–¥–µ–º–æ).")
        return await query.answer()

    if data == "make_4k":
        # –ó–∞–≥–ª—É—à–∫–∞ UI ‚Äî –ø–æ–¥–∫–ª—é—á–∏–º Luma –ø–æ–∑–∂–µ
        await msg.answer("‚öôÔ∏è –ì–æ—Ç–æ–≤–ª—é 4K‚Ä¶ (—á–µ—Ä–µ–∑ Luma –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)")
        return await query.answer()
