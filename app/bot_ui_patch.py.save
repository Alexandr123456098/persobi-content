import os, asyncio, logging, tempfile
from pathlib import Path
from aiogram import types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.exceptions import InvalidQueryID

from app.adapters.replicate_adapter import ReplicateClient
from app.adapters.offline_adapter   import OfflineClient
from app.adapters.luma_adapter      import LumaClient

log = logging.getLogger("ui")

OUT_DIR = os.environ.get("OUT_DIR", "/opt/content_factory/out")
Path(OUT_DIR).mkdir(parents=True, exist_ok=True)

# –ª–µ–Ω–∏–≤—ã–µ —Å–∏–Ω–≥–ª—Ç–æ–Ω—ã ‚Äî –ù–ï —Å–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —ç—Ç–∞–ø–µ –∏–º–ø–æ—Ä—Ç–∞
_replicate = None
_offline  = None
_luma     = None

# -------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–æ–ª–∏–∫–∞
# -------------------------------
DURATION_PREF = {}  # chat_id -> int (5/10/15)

def _get_duration(chat_id: int) -> int:
    """–í–µ—Ä–Ω—É—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 —Å–µ–∫."""
    return int(DURATION_PREF.get(chat_id, 5))

def _set_duration(chat_id: int, seconds: int):
    """–ó–∞–ø–æ–º–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (5, 10 –∏–ª–∏ 15 —Å–µ–∫)."""
    if seconds in (5, 10, 15):
        DURATION_PREF[chat_id] = seconds


def _ensure_clients():
    global _replicate, _offline, _luma
    if _replicate is None:
        _replicate = ReplicateClient(OUT_DIR)
        _offline   = OfflineClient(OUT_DIR)
        _luma      = LumaClient(OUT_DIR)

def kb_duration():
    kb = InlineKeyboardMarkup()
    kb.row(
        InlineKeyboardButton("5 —Å–µ–∫",  callback_data="dur_5"),
        InlineKeyboardButton("10 —Å–µ–∫", callback_data="dur_10"),
        InlineKeyboardButton("15 —Å–µ–∫", callback_data="dur_15"),
    )
    return kb

def kb_ready_extended():
    kb = InlineKeyboardMarkup(row_width=2)
    kb.add(
        InlineKeyboardButton("üîÅ –ï—â—ë —Ä–∞–∑", callback_data="again"),
        InlineKeyboardButton("üß© SORA 2", callback_data="sora2"),
    )
    kb.add(
        InlineKeyboardButton("üß∑ –¢–æ—á–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç", callback_data="product_exact"),
    )
    kb.add(
        InlineKeyboardButton("‚è± –í—ã–±—Ä–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", callback_data="choose_duration"),
    )
    return kb

# --- helpers ---

def _get_last_prompt(state, chat_id: int, default: str = "–ø–æ–≤—Ç–æ—Ä–∏ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ü–µ–Ω—É"):
    return state["last_prompt"].get(chat_id, default)

def _set_last_prompt(state, chat_id: int, prompt: str):
    if prompt:
        state["last_prompt"][chat_id] = prompt.strip()

def _cinema_prompt(user_text: str) -> str:
    """
    –ü—Ä–æ—Å—Ç–æ–π –ª–æ–∫–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω: –∏–∑ —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è —Å–æ–±–∏—Ä–∞–µ–º –∞–Ω–≥–ª–æ—è–∑—ã—á–Ω—É—é
    ¬´—Ä–µ–∂–∏—Å—Å—ë—Ä—Å–∫—É—é¬ª –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é. –ë–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö API.
    """
    raw = (user_text or "").strip()
    if not raw:
        return "A short cinematic shot, professional lighting."

    raw_oneline = " ".join(raw.split())

    template = [
        "Cinematic short video. Romantic, tasteful, natural acting.",
        f'Source request (ru): "{raw_oneline}"',
        "Atmosphere: cozy, elegant interior, believable props, no text overlays.",
        "Lighting: cinematic soft key light, warm practical lights, gentle rim light, natural falloff.",
        "Camera: gentle dolly-in and very slow pan, steady shot, smooth motion.",
        "Shot order: 1) wide establishing shot of the scene, 2) medium shot of main subjects, 3) close-up detail for emphasis.",
        "Optics: shallow depth of field, soft bokeh, professional film composition.",
        "Grade: warm color grading, subtle film grain, 4K framing, clean background.",
    ]
    return "\n".join(template)


# --- handlers ---

async def handle_text(message: types.Message, bot_state):
    _ensure_clients()
    prompt = (message.text or "").strip()
    if not prompt:
        return await message.answer("–ù–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã.")
    _set_last_prompt(bot_state, message.chat.id, prompt)

    await message.answer("üõ† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø—Ä–µ–≤—å—é‚Ä¶")
    prompt = _cinema_prompt(prompt)
    import os  # –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –≤–≤–µ—Ä—Ö—É ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–π
    if os.environ.get("ECHO_PROMPT", "0") == "1":
        await message.answer(f"üé¨ –†–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–π –ø—Ä–æ–º—Ç:\n\n{prompt[:1800]}")
    loop = asyncio.get_event_loop()
    try:
        dur = _get_duration(message.chat.id)
        path = await loop.run_in_executor(None, _replicate.generate, prompt, dur)
        log.info("[ui] replicate(photo) OK: %s", path)
    except Exception as e:
        log.warning("[ui] replicate failed: %s, fallback offline", e)
        path = await loop.run_in_executor(None, _offline.generate, prompt, 5)

    with open(path, "rb") as f:
        await message.answer_video(f, caption="‚úÖ –ì–æ—Ç–æ–≤–æ. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:", reply_markup=kb_ready_extended())
async def _ack_cb(query: types.CallbackQuery):
    try:
        await query.answer(cache_time=0)
    except InvalidQueryID:
        log.warning("[bot] callback ack missed window (InvalidQueryID); continue")

async def handle_photo(message: types.Message, bot_state):
    """
    –§–æ—Ç–æ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ, –ø—Ä–æ–º–ø—Ç –±–µ—Ä—ë–º –∏–∑ caption.
    –ï—Å–ª–∏ —É ReplicateClient –µ—Å—Ç—å generate_from_image(img_path, prompt, duration) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º; –∏–Ω–∞—á–µ –≤—Ä–µ–º–µ–Ω–Ω–æ t2v –ø–æ caption.
    """
    _ensure_clients()
    caption = (message.caption or "").strip()
    caption = _cinema_prompt(caption)
    if os.environ.get("ECHO_PROMPT", "0") == "1":
        await message.answer(f"üé¨ –†–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–π –ø—Ä–æ–º—Ç:\n\n{prompt[:1800]}")
    _set_last_prompt(bot_state, message.chat.id, caption or "—Å–¥–µ–ª–∞–π –≤–∏–¥–µ–æ –ø–æ —Ñ–æ—Ç–æ")

    await message.answer("üõ† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø—Ä–µ–≤—å—é –ø–æ —Ñ–æ—Ç–æ‚Ä¶")
    loop = asyncio.get_event_loop()

    tmp_path = None
    try:
        ph = message.photo[-1]  # largest size
        fd, tmp_path = tempfile.mkstemp(prefix="cf_photo_", suffix=".jpg", dir=OUT_DIR)
        os.close(fd)
        await ph.download(destination_file=tmp_path)  # aiogram v2

        if hasattr(_replicate, "generate_from_image"):
            gen = lambda: _replicate.generate_from_image(tmp_path, caption or "", 5)
        else:
            gen = lambda: _replicate.generate(caption or "—Å–æ–∑–¥–∞–π –≤–∏–¥–µ–æ –ø–æ —Ñ–æ—Ç–æ", 5)

        path = await loop.run_in_executor(None, gen)
        log.info("[ui] replicate(photo) OK: %s", path)
    except Exception as e:
        log.warning("[ui] photo flow failed: %s ‚Äî fallback offline", e)
        path = await loop.run_in_executor(None, _offline.generate, caption or "—Å—Ü–µ–Ω–∞ –ø–æ —Ñ–æ—Ç–æ", 5)
    finally:
        if tmp_path and os.path.exists(tmp_path):
            try:
                os.remove(tmp_path)
            except Exception:
                pass

    with open(path, "rb") as f:
        await message.answer_video(f, caption="‚úÖ –ì–æ—Ç–æ–≤–æ. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:", reply_markup=kb_ready_extended())

async def handle_callback(query: types.CallbackQuery, bot_state):
    _ensure_clients()
    data = (query.data or "").strip()
    chat_id = query.message.chat.id
        # --- –≤—ã–±–æ—Ä –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ---
    if data in ("choose_duration", "dur_5", "dur_10", "dur_15"):
        if data == "choose_duration":
            await query.message.answer("–í—ã–±–µ—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:", reply_markup=kb_duration())
        else:
            sec = int(data.split("_")[1])
            _set_duration(chat_id, sec)
            await query.message.answer(f"‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: {sec} —Å–µ–∫.")
        return await _ack_cb(query)

    # --- —Ç–æ—á–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç (–∫–∞—Ç–∞–ª–æ–∂–Ω—ã–π —Ä–æ–ª–∏–∫ –∏–∑ —Ñ–æ—Ç–æ) ---
    if data == "product_exact":
        # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–∏—Å–ª–∞–Ω–Ω–æ–µ —Ñ–æ—Ç–æ ‚Äî –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, –ø—Ä–æ—Å–∏–º –ø—Ä–∏—Å–ª–∞—Ç—å —Å–µ–π—á–∞—Å
        img_path = None
        try:
            # –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å —Å–≤–æ–π –∫—ç—à —Ñ–æ—Ç–æ ‚Äî –ø–æ–¥–∫–ª—é—á–∏–º –µ–≥–æ
            from app.bot_handlers_patch import LAST_PHOTO_PATH
            img_path = LAST_PHOTO_PATH.get(chat_id)
        except Exception:
            img_path = None

        if not img_path or not os.path.exists(img_path):
            await query.message.answer("üì∏ –ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–±–µ–∑ —Å–∂–∞—Ç–∏—è –º–æ–∂–Ω–æ). –ü–æ—Ç–æ–º —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏ ¬´üß∑ –¢–æ—á–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç¬ª.")
            return await _ack_cb(query)

        duration = _get_duration(chat_id)

        # –¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏ ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–º–ø—Ç, –æ—Ç–¥–∞–¥–∏–º –∫–∞–∫ –ø–æ–¥–ø–∏—Å—å –¥–ª—è product_exact
        tts_text = ""
        try:
            from app.bot_handlers_patch import LAST_PROMPT
            tts_text = LAST_PROMPT.get(chat_id, "")
        except Exception:
            tts_text = ""

        await query.message.answer("üß∑ –°–æ–±–∏—Ä–∞—é —Ç–æ—á–Ω—ã–π —Ä–æ–ª–∏–∫ –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–æ—Ç–æ‚Ä¶")
        loop = asyncio.get_event_loop()

        def _run_product():
            import subprocess
            cmd = ["/opt/content_factory/app/pipelines/product_exact.py", img_path, str(duration)]
            if tts_text:
                cmd.append(tts_text)
            p = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)
            if p.returncode != 0:
                raise RuntimeError(p.stdout)
            # –°–∫—Ä–∏–ø—Ç –ø–µ—á–∞—Ç–∞–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ mp4
            return p.stdout.strip()

        try:
            path = await loop.run_in_executor(None, _run_product)
            with open(path, "rb") as f:
                await query.message.answer_video(f, caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ. –¢–æ—á–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç, {duration} —Å–µ–∫.", reply_markup=kb_ready_extended())
        except Exception as e:
            await query.message.answer(f"‚ö†Ô∏è –ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å —Ç–æ—á–Ω—ã–π —Ä–æ–ª–∏–∫: {e}")
        return await _ack_cb(query)
        loop = asyncio.get_event_loop()

    if data in ("again", "sora2"):
        msg = "üõ† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –µ—â—ë —Ä–∞–∑‚Ä¶" if data == "again" else "üß© –ì–µ–Ω–µ—Ä–∏—Ä—É—é SORA 2‚Ä¶"
        await query.message.answer(msg)

        prompt = _get_last_prompt(bot_state, chat_id)
        prompt = _cinema_prompt(prompt)
        try:
            path = await loop.run_in_executor(None, _replicate.generate, prompt, 5)
            log.info("[ui] replicate(photo) OK: %s", path)
        except Exception as e:
            log.warning("[ui] replicate failed: %s, fallback offline", e)
            path = await loop.run_in_executor(None, _offline.generate, prompt, 5)

        with open(path, "rb") as f:
            await query.message.answer_video(f, caption="‚úÖ –ì–æ—Ç–æ–≤–æ. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:", reply_markup=kb_ready_extended())
        await _ack_cb(query)

    

    await _ack_cb(query)
