from aiogram import types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
import os, asyncio
from app.adapters.offline_adapter import OfflineClient

OUT_DIR = os.environ.get("OUT_DIR", "/opt/content_factory/out")
offline = OfflineClient(OUT_DIR)

def kb_ready():
    kb = InlineKeyboardMarkup(row_width=3)
    kb.row(
        InlineKeyboardButton("üîÅ –ï—â—ë —Ä–∞–∑", callback_data="again"),
        InlineKeyboardButton("üìê 720p‚Üî1080p", callback_data="toggle_res"),
        InlineKeyboardButton("üü© 4K", callback_data="make_4k"),
    )
    return kb

async def handle_text(message: types.Message, state):
    prompt = (message.text or "").strip()
    if not prompt:
        return
    m = await message.answer("üõ† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø—Ä–µ–≤—å—é‚Ä¶")

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ñ–ª–∞–π–Ω-–ø—Ä–µ–≤—å—é
    path = await offline.generate_video(prompt, seconds=5)
    caption = "‚úÖ –ì–æ—Ç–æ–≤–æ. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"
    await message.answer_video(open(path, "rb"), caption=caption, reply_markup=kb_ready())
    await m.delete()

async def handle_callback(query: types.CallbackQuery, state):
    data = query.data
    if data == "again":
        await query.answer("üîÅ –ï—â—ë —Ä–∞–∑")
        path = await offline.generate_video("–ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä", seconds=5)
        caption = "‚úÖ –ì–æ—Ç–æ–≤–æ. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä "
        await query.message.answer_video(open(path, "rb"), caption=caption, reply_markup=kb_ready())
    elif data == "toggle_res":
        await query.answer("üìê –ü–µ—Ä–µ–∫–ª—é—á–∏–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (–¥–µ–º–æ)")
    elif data == "make_4k":
        await query.answer("üü© –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é 4K (—á–µ—Ä–µ–∑ Luma/Replicate)")
